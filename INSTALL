###
Installing Asterisk Management Portal (AMP)


###
AMP has several requirements, including the following packages (names may vary based on distro):

	libxml2
	libtiff
	libtiff-devel
	lame
	httpd (or Apache2)
	mysql (or mysql-client)
	mysql-devel (or libmysqlclient10-dev)
	mysql-server
	php (or php4) 
	(on debian, also install libapache2-mod-php4)
	php4-pear (if pear is not included with your php)
	php-mysql
	openssl
	openssl-devel (or libssl-dev)
	kernel-source (or linux-source)
	perl
	perl-CPAN
	cvs
	bison
	ncurses-devel (or libncurses5-dev)
	curl
	sox

### Perl module Net::Telnet is required:
	
	 perl -MCPAN -e "install Net::Telnet"

###		
Some linux distros have replaced the mpg123 application with another application, mpg321, and created a symbolic link to "mpg123", so it seems to work in the same way. Asterisk MusicOnHold only works with original mpg123.

	- Remove the symbolic links mpg123 located in /usr/bin and /usr/local/bin:
	- rm /usr/bin/mpg123
	- rm /usr/local/bin/mpg123 
	- Then install mpg123 from http://www.mpg123.de
	
###
AMP requires the following changes to php and apache for uploading new MOH files:


	- vi +482 /etc/php.ini  (or /etc/php4/apache2/php.ini)
		upload_max_filesize=20M
	- vi +14 /etc/httpd/conf.d/php.conf (if you have it)
		LimitRequestBody 20000000
		
		
###
Download asterisk-perl from http://asterisk.gnuinter.net and install it

	
###
Mime-contruct is needed to generate emails with fax file attachments:

	- perl -MCPAN -e "install IPC::Signal"
	
	- perl -MCPAN -e "install Proc::WaitStat"
	
	- download mime-construct from http://search.cpan.org/~rosch/mime-construct-1.8
	- install it

###
Download the latest AMP files:

	- download the latest AMP tarball to /usr/src
	- tar -zxvf AMP<version>.tar.gz

###
Getting Asterisk and Zaptel (AMP uses the v1.0 branch)

	- cd /usr/src
	- export CVS_RSH=
	- export CVSROOT=:pserver:anoncvs@cvs.digium.com:/usr/cvsroot
	- cvs login      (the password is: anoncvs)
	- cvs checkout -r v1-0 zaptel libpri asterisk asterisk-addons asterisk-sounds


###
For TDM zap devices (FXO/FXS):

	- cd /usr/src/zaptel
	- make && make install

	This will build the wcfxo.o (and wcfxs.o) module/driver which needs to be loaded (as root) into the kernel:

	- modprobe wcfxs (or wcfxo for x100p)

	Confirm that the module is loaded with lsmod:

		[root@myhost root]# lsmod | grep wcfxo
		wcfxs                  9280   0  (unused)
		zaptel                179584   0  [wcfxs]

	
###
Patching Asterisk with softfax/spandsp.

	- Download the latest spandsp files from http://www.soft-switch.org
	- cd /usr/src/spandsp-xxx
	- ./configure
	- make && make install

	The spandsp libraries are installed to /usr/local/lib.  Therefore /usr/local/lib must be added to the LD_LIBRARY_PATH environment variable of the user that starts the asterisk process. To be safe, also add it to /etc/ld.so.conf and run ldconfig.

	Copy the following files (from soft-switch.org) to /usr/src/asterisk/apps/ :

		- cp app_rxfax.c /usr/src/asterisk/apps/
		- cp app_txfax.c /usr/src/asterisk/apps/
		- cp apps_makefile.patch /usr/src/asterisk/apps/

	- cd /usr/src/asterisk/apps
	- patch < apps_makefile.patch

		
###
Create a group and non-root user:

	- groupadd asterisk
	- useradd -c "asterisk PBX" -d /var/lib/asterisk -u 5060 -g asterisk asterisk
	
	
###
Building Asterisk and configuring it to run as a non-root user

	- Edit /usr/src/asterisk/Makefile such that (~ line 122):

		ASTVARRUNDIR=$(INSTALL_PREFIX)/var/run/asterisk

	- make clean && make && make install

	The user that will run the asterisk process (asterisk) must own several directories/files.  We'll take care of that later.

	
###
Get and build cdr_mysql module for asterisk

	- cd /usr/src/asterisk-addons
	- make clean && make && make install
	
###
Install asterisk-sounds

	- cd /usr/src/asterisk-sounds
	- make install
	
###
Setting up MySQL for CDR and AMP web interface

	- /usr/bin/mysql_install_db
	- /etc/init.d/mysqld start (or /etc/init.d/mysql start) 

	- mysqladmin -u root password 'db_root_pwd'
	- mysqladmin create asteriskcdrdb -p
	- mysql --user=root --password=db_root_pwd asteriskcdrdb < /usr/src/AMP/SQL/cdr_mysql_table.sql
	
	- mysqladmin create asterisk -p
	- mysql --user root -p asterisk < /usr/src/AMP/SQL/newinstall.sql

	
###
Grant access to these two databases you just created

**Note the default mysql username/password is asteriskuser/amp109.  
**If you change either of these, you will be prompted for them while running ./install below

	- mysql --user root -p

		mysql> GRANT ALL PRIVILEGES ON asteriskcdrdb.* TO asteriskuser@localhost IDENTIFIED BY 'amp109';
		Query OK, 0 rows affected (0.00 sec)

		mysql> GRANT ALL PRIVILEGES ON asterisk.* TO asteriskuser@localhost IDENTIFIED BY 'amp109';
		Query OK, 0 rows affected (0.00 sec)
		
		mysql> quit

###
Run the "install" script to install all the AMP files:  

	- /usr/src/AMP/install_amp
	
###
Configure Flash Operator Panel for your zap channels:
	
	- Modify lines 21+ of /var/www/html/admin/retrieve_op_conf_from_mysql.pl to reflect the number of zap channels you have
		

###
Configure zaptel driver:

	- edit /etc/zaptel.conf to reflect installed digium interfaces (see /etc/zaptel.conf.template)
	- ztcfg -v

			Zaptel Configuration
			======================
			
			1 channels configured.


###
Configure zapata module in asterisk config.

	- edit /etc/asterisk/zapata.conf to reflect installed FXO digium interfaces (see zapata.conf.template)
	- IMPORTANT! - ensure that FXO zap channels have "group=0"


###
httpd (Apache) configuration

	- Edit /etc/httpd/conf/httpd.conf (or /etc/apache2/apache2.conf) so that:

		User asterisk
		Group asterisk
		
	- If you wish to secure your AMP admin directory:
	
		(change "/var/www/html" to reflect your web root):
		
		#Password protect AMP admin  
		<Directory /var/www/html/admin>
		AuthType Basic
		AuthName "Restricted Area"
		AuthUserFile /usr/local/apache/passwd/wwwpasswd
		Require user wwwadmin
		</Directory>

		- and create the wwwpasswd file:

		mkdir /usr/local/apache
		mkdir /usr/local/apache/passwd
		htpasswd -c /usr/local/apache/passwd/wwwpasswd wwwadmin


###
Asterisk user environment

	- Edit /var/lib/asterisk/.bash_profile to include /usr/sbin in the PATH and set the LD_LIBRARY_PATH variable:

		PATH=$PATH:/usr/sbin:$HOME/bin
		export PATH
		export LD_LIBRARY_PATH=/usr/local/lib

	- Edit /etc/ld.so.conf to include spandsp libs:
		
		/usr/local/lib
	
	- run ldconfig

###
Auto Start

	- Add to /etc/rc.d/rc.local:
	
		echo ADDING WCFXS   (use module suitable for your zap interface)
		/sbin/modprobe wcfxs
		echo STARTING ASTERISK
		/usr/sbin/amportal start

	
###
Start everything:

	- ensure your PATH includes /usr/sbin

	- As root run:

		service httpd restart
		(or /etc/init.d/apache2 restart)

	- As root run:

		/usr/sbin/amportal start

	- Point your browser to:

		http://[ip address]


