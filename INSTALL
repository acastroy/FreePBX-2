###
Installing Asterisk Management Portal (AMP)


###
AMP has several requirements, including the following packages (names may vary based on distro):

	libxml2
	libtiff
	libtiff-devel
	lame
	httpd (or Apache2)
	mysql (or mysql-client)
	mysql-devel (or libmysqlclient10-dev)
	mysql-server
	php (or php4) 
	(on debian, also install libapache2-mod-php4)
	php4-pear (if pear is not included with your php)
	php-mysql
	(on SUSE, also install php4-gettext and php4-session)
	openssl
	openssl-devel (or libssl-dev)
	kernel-source (or linux-source)
	perl
	perl-CPAN
	cvs
	bison
	ncurses-devel (or libncurses5-dev)
	audiofile-devel (or libaudiofile-devel)
	curl
	sox

### Install these Perl modules:
	
	perl -MCPAN -e "install Net::Telnet"
	
	perl -MCPAN -e "install IPC::Signal"
	
	perl -MCPAN -e "install Proc::WaitStat"

###
Mime-contruct is needed to generate emails with fax file attachments:


	- download the latest mime-construct from http://search.cpan.org/~rosch/
	- install it

###
Download asterisk-perl from http://asterisk.gnuinter.net and install it

###		
Some linux distros have replaced the mpg123 application with another application, mpg321, and created a symbolic link to "mpg123", so it seems to work in the same way. Asterisk MusicOnHold only works with original mpg123.

	Remove the mpg321 package installed by your distro, 
	or
	Remove the symbolic links mpg123 located in /usr/bin and /usr/local/bin:
	- rm /usr/bin/mpg123
	- rm /usr/local/bin/mpg123 
	
	Then install mpg123 from http://www.mpg123.de
	
###
AMP requires the following changes to php and apache for uploading new MOH files:


	- vi +482 /etc/php.ini  (or /etc/php4/apache2/php.ini)
		upload_max_filesize=20M
	- vi +14 /etc/httpd/conf.d/php.conf (if you have it)
		LimitRequestBody 20000000
		
	- might also need to set register_globals = on in the php.ini for displaying CDR logs in
	  the AMP interface

###
Download the latest AMP files:

	- download the latest AMP tarball to /usr/src
	- tar -zxvf AMP<version>.tar.gz

###
Getting Asterisk and Zaptel from CVS or download the latest Asterisk and Zaptel source archives
(AMP uses the v1.0 branch)

	- cd /usr/src
	- export CVS_RSH=
	- export CVSROOT=:pserver:anoncvs@cvs.digium.com:/usr/cvsroot
	- cvs login      (the password is: anoncvs)
	- cvs checkout -r v1-0 zaptel libpri asterisk asterisk-addons asterisk-sounds

(As of 2005-11-02, AMP 010 has been tested with Asterisk 1.2 beta1)

###
For TDM zap devices (FXO/FXS):

	- cd /usr/src/zaptel
	- make && make install

	If you will be using a Digium telephony card that supports T1/E1 signaling do this step as well:
	- cd /usr/src/libpri
	- make && make install
	
###
Patching Asterisk with softfax/spandsp.

	- Download the latest spandsp files from http://www.soft-switch.org
	- cd /usr/src/spandsp-xxx
	- ./configure
	- make && make install

	The spandsp libraries are installed to /usr/local/lib.  Therefore /usr/local/lib must be added to the LD_LIBRARY_PATH environment variable of the user that starts the asterisk process. To be safe, also add it to /etc/ld.so.conf and run ldconfig.

	Copy the following files (from soft-switch.org) to /usr/src/asterisk/apps/ :

	- cp app_rxfax.c /usr/src/asterisk/apps/
	- cp app_txfax.c /usr/src/asterisk/apps/
	- cp apps_makefile.patch /usr/src/asterisk/apps/

	- cd /usr/src/asterisk/apps
	- patch < apps_makefile.patch

		
###
Create a group and non-root user:

	- groupadd asterisk
	- useradd -c "asterisk PBX" -d /var/lib/asterisk -g asterisk asterisk
	
	
###
Building Asterisk and configuring it to run as a non-root user

	- mkdir /var/run/asterisk
	- cd /usr/src/asterisk
	- make clean && make && make install

###
Get and build cdr_mysql module for asterisk

	- cd /usr/src/asterisk-addons
	- perl -p -i.bak -e 's/CFLAGS.*D_GNU_SOURCE/CFLAGS+=-D_GNU_SOURCE\nCFLAGS+=-DMYSQL_LOGUNIQUEID/' Makefile
	- make clean && make && make install
	
###
Install asterisk-sounds

	- cd /usr/src/asterisk-sounds
	- make install
	
###
Setting up MySQL for CDR and AMP web interface

	- /usr/bin/mysql_install_db
	- /etc/init.d/mysqld start (or /etc/init.d/mysql start) 

	- mysqladmin -u root password 'db_root_pwd'
	- mysqladmin create asteriskcdrdb -p
	- mysql --user=root --password=db_root_pwd asteriskcdrdb < /usr/src/AMP/SQL/cdr_mysql_table.sql
	
	- mysqladmin create asterisk -p
	- mysql --user root -p asterisk < /usr/src/AMP/SQL/newinstall.sql

	
###
Grant access to these two databases you just created

**Note the default mysql username/password is asteriskuser/amp109.  
**If you change either of these, you will be prompted for them while running ./install below

	- mysql --user root -p

		mysql> GRANT ALL PRIVILEGES ON asteriskcdrdb.* TO asteriskuser@localhost IDENTIFIED BY 'amp109';
		Query OK, 0 rows affected (0.00 sec)

		mysql> GRANT ALL PRIVILEGES ON asterisk.* TO asteriskuser@localhost IDENTIFIED BY 'amp109';
		Query OK, 0 rows affected (0.00 sec)
		
		mysql> quit

###
Run the "install" script to install all the AMP files:  

	- /usr/src/AMP/install_amp
	
###
Configure Flash Operator Panel for your zap channels:
	
	- Modify lines 21+ of /var/www/html/admin/retrieve_op_conf_from_mysql.pl to reflect the number of zap channels you have
		

###
Configure zaptel driver:

	a. Edit /etc/zaptel.conf to reflect installed Digium telephony card(s).
	
        Only the parameters/values relevant to a TDM400P with 4 FXO modules are included below:

	fxsks=1-4
	loadzone=us
	defaultzone=us

        Only the parameters/values relevant to a TE110P (T1 configuration) are included below:
        
	span=1,1,0,esf,b8zs
	bchan=1-23
	dchan=24
	loadzone=us
	defaultzone=us

	b. ztcfg -v

			Zaptel Configuration
			======================
			
			1 channels configured.
	
	If you get a warning about unable to open master device /dev/zap/ctl, that's ok.  It's a result
	of the zaptel module(s) not loaded yet.



        Detailed information with regard to Asterisk's configuration files can be found here:
	http://voip-info.org/wiki-Asterisk+config+files

###
Configure zapata module in asterisk config.

	- edit /etc/asterisk/zapata.conf to reflect installed digium interfaces (see zapata.conf.template)

	Only the parameters/values relevant to a TDM400P with 4 FXO modules are included below:

	[channels]
	language=en
	context=from-pstn
	signalling=fxs_ks
	faxdetect=incoming
	usecallerid=yes
	callerid=asreceived
	echocancel=yes
	callprogress=no
	busydetect=no
	echocancelwhenbridged=no
	echotraining=800
	group=0
	channel=1-4


	Only the parameters/values relevant to a TE110P (T1 configuration) are included below:

	[channels]
	language=en
	context=from-pstn
	switchtype=national
	pridialplan=national
	signalling=pri_cpe
	faxdetect=incoming
	usecallerid=yes
	echocancel=yes
	callerid=asreceived
	echocancelwhenbridged=no
	echotraining=800
	group=0
	channel=1-23


	Note: if your configuration is using zap channels as FXS endpoints, zapata.conf must
	contain the following line in order to provision these endpoints in AMP's Extensions admin:
	#include zapata_additional.conf

	Detailed information with regard to Asterisk's configuration files can be found here:
	http://voip-info.org/wiki-Asterisk+config+files

###
httpd (Apache) configuration

	- Edit /etc/httpd/conf/httpd.conf (or /etc/apache2/apache2.conf) so that:

		User asterisk
		Group asterisk
		
	- If you wish to secure your AMP admin directory:
	
		(change "/var/www/html" to reflect your web root):
		
		#Password protect AMP admin  
		<Directory /var/www/html/admin>
		AuthType Basic
		AuthName "Restricted Area"
		AuthUserFile /usr/local/apache/passwd/wwwpasswd
		Require user wwwadmin
		</Directory>

		- and create the wwwpasswd file:

		mkdir /usr/local/apache
		mkdir /usr/local/apache/passwd
		htpasswd -c /usr/local/apache/passwd/wwwpasswd wwwadmin

###
Amportal Control Script

	Version 1.10.004 of AMP provided a new control script. The functionality of which is to start,
	stop or kill services in the AMP environment, or to set permissions on directories/files in the
	AMP environment:

	[root@pbx root]# amportal
	
	----------AMP Control Script-----------
	Usage: amportal start|stop|kill|chown
	start: Starts Asterisk and Flash Operator Panel server
	stop: Gracefully stops Asterisk and the FOP server
	kill: Kills Asterisk and the FOP server
	chown: Sets appropriate permissions on files
	
	The amportal script is the recommended way to stop and start asterisk:
	
	[root@pbx root]# /usr/sbin/amportal stop
	[root@pbx root]# /usr/sbin/amportal start

###
Auto Start

	The module/driver that you load at boot time depends upon whether you are using a
	TDM400P or TE110P. The wcfxs module should be loaded for the former and the wcte11xp
	module should be loaded for the latter. (In recent Asterisk code the functionality provided by
	wcfxs is provided in wctdm. At the time of this writing the AMP/Asterisk build does indeed use
	wcfxs for the TDM400P telephony card.)

	The following scripts are for RedHat and derivatives that use an rc.local:
	
	Edit /etc/rc.d/rc.local to include the following for the TDM400P:
	#!/bin/sh
	#
	# This script will be executed *after* all the other init scripts.
	# You can put your own initialization stuff in here if you don't
	# want to do the full Sys V style init stuff.
	touch /var/lock/subsys/local
	echo Loading wcfxs
	/sbin/modprobe wcfxs
	/usr/sbin/amportal start

	Edit /etc/rc.d/rc.local to include the following for the TE110P:

	#!/bin/sh
	#
	# This script will be executed *after* all the other init scripts.
	# You can put your own initialization stuff in here if you don't
	# want to do the full Sys V style init stuff.
	touch /var/lock/subsys/local
	echo Loading wcte11xp
	/sbin/modprobe wcte11xp
	/usr/sbin/amportal start

	For Debian and others (?), you'll have to add startup script(s) to /etc/init.d and link them
	to the appropriate rc?.d runlevel.

	
	Also ensure that mysql and apache are set to start at bootup.

###
Start everything (or reboot and it should start automagically):

	- As root run:

		service httpd restart
		(or /etc/init.d/apache2 restart)

	- As root run:

		amportal start

	- Point your browser to:

		http://[ip address]

If you notice any errors or updates that are needed to this document, please e-mail:
info@coalescentsystems.ca
